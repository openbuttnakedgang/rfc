# Кратко

В документе описывается обновленный интерфейс работы с холтерами

## Что изменилось

* Новая система команд, в виде регистров с возможностью чтения/записи
* Система команд строится на основе файла описания
* Описание устройства поставляется внешним файлом
* Более строгий цикл работы/использования устройства
* DFU загрузчик

# Мотивация

Приняты к сведению ошибки/недостатки предыдущей реализации интерфейса:

* Размытое представление об цикле работы устройства
* Дублирование (одни и те же вещи делаются разными способами)
* Отсутствие гарантий времени хранения разных типов настроек
* Хранение избыточных мета-данных внутри прошивки (Файловая система)

В приоритете было:

* Максимально упростить/уменьшить код в устройстве
* Расширяемая система команд для разных типов устройств

# Общее

## Файл описания устройства

Файл описания устройства в TOML формате (TOML - JSON совместимый формат).  
Описывает общие сведения о типе устройства.  
Пример файла:  

``` toml
[device]
type = 777
name = "Incart Holter Model 777"
dev-capacity = "1000M" # 1 M = 1 MiBi = 1024 * 1024 bytes
block-size = 2048      # Размер блока записи обследования

# В настоящем формате паковки, вся информация о группах каналов и их параметрах закодирована в idfmt
# так что нет смысла описывать каждую группу каналов подробно, только если для "человеко-читаемости"

# Достаточно просто перечислить idfmt поддерживаемые устройством.

# Список поддерживаемых idfmt
idfmt = ["0x0001", "0x0002", "0x0003", "0x0004"]

```

## Система команд

Система команд представляет собой множество атомарных команд - *регистров*.  
Регистры объединены в группы - *секции*.  

Пример:

``` text
    ctrl
      +--- conf
      +--- record
      +--- vis
      +--- goto-loader

    state
      +--- block-cnt
      +--- voltage
      +--- stop-reason

```

Что можно делать с регистрами:

* Регистры **типизированы** т.е. имеют определенный тип (U8, STR, I32 ..).
* Регистры и секции обладают флагами доступа (RW, RO, WO).
* В регистр можно читать и писать (если флаги доступа позволяют).
* Для записи и чтения нужно использовать полное имя регистра `/секция/регистр`.

### Фрагмент файла описания системы команд

``` toml

[ctrl]
"@access" = "RW"
conf = "bool"      # режим постановки
record = "bool"    # режим записи
vis = "bool"       # визуализация
calib = "bool"     # режим калибровки
goto-loader = "()" # переход в загрузчик
[ctrl.event]       # запись события (метки)
"@access" = "WO"
"@type" = "[u8]"

[state]
block-cnt = "u32"   # записано блоков
voltage = "i32"     # напряжение питания
current = "i32"     # потребляемый ток
stop-reason = "u32" # причина остановки записи обследования

```

## Цикл работы устройства

![usage_dia](https://raw.githubusercontent.com/openbuttnakedgang/rfc/master/assets/images/usage.png)

Цикл работы устройства состоит из нескольких состояний:

* Простой
* Постановка
* Запись
* Калибровка
* Загрузчик

**!!! Согласно диаграмме переход из состояния в состояние возможен только по направелнию указанному стрелочкой**

### Основные идеи

Программируемые параметры устройства разделены по времени их хранения в памяти устройства:

* Параметры обследования - гарантируется их хранение от одного обследования до другого.
* Калибровки - гарантируется их постоянное хранение.

Под параметрами обследования понимаются вообще все настройки устройства, кроме калибровок.  
Установка параметров обследования возможна только из состояния **постановка**. Установка калибровок возможна только из состояния **калибровка**. Осуществлять чтение любых параметров можно из любых состояний.  
Параметры обследования хранятся пока не начата новая **постановка**. Калибровки хранятся постоянно, стираются при переходе в состояние **калибровка** (что бы освободить место для записи новых калибровок)

### Типовой алгоритм

I. Устройство начинает с **простоя**. В этом состоянии все еще доступны результаты и настройки предыдущего
обследования. При переходе в состоянии **постановка** (1.), стирается вся информация о предыдущем обследовании.

II. В состоянии **постановка** осуществляется установка всех параметров обследования (ФИО, время и т.п.).
После установки всех необходимых параметров, можно перейти (3.) в состояние **запись**.

III. При переходе (3.) в состояние **запись** проверяется наличие необходимых установленных параметров, если их нет, то переход не осуществляется.

IV. В **записи** нельзя изменять или устанавливать параметры обследования. Можно считать текущее обследование.
Выход из режима записи (4.) осуществляется явно по внешней команде или автоматический (свободное место закончилось).

V. После выхода из **записи** устройство переходит (4.) в **простой**. В этом состоянии можно считать последнее обследование.

## Параметры по-умолчанию

Параметров по-умолчанию нет, за исключением особых случаев, таких как:

* детский режим по-умолчанию для устройств с измерением АД
* при само-постановке устройства

# Технические подробности

## Особенности и ограничения

### Применение настроек

При программировании параметров их применение происходит не сразу, а только после перехода в следующее состояние устройства (См. Цикл работы устройства).
Например, если в состоянии **постановка** была запрограммирована частота АЦП 1 кГц, то фактический АПЦ переключится на эту частоту только после перехода в состояние **запись**.

### Перезапуск USB

При переходе из одного состояния в другое (См. Цикл работы устройства), устройство выполняет быстрый перезапуск.
В следствии чего будет выполняться **переподключение устройства USB**.  
Такой подход значительно упрощает код устройства и решает проблему с недетерменированным временем таймаутов.

## DFU Загрузчик

Загрузчик использует DFU USB спецификацию [Device Firmware Upgrade](http://www.usb.org/developers/docs/devclass_docs/DFU_1.1.pdf),
широко распространенный стандарт, применяющийся для обновления прошивок разнообразных устройств.

## О Windows драйверах

О ситуации с драйверами на Windows:

*The Windows driver model introduces an additional requirement. Unlike the platforms above the ability to open a USB device from a user application is not the default, even if there is no driver loaded. Instead there is a special driver, WinUSB, that needs to be loaded in order to provide the interface applications use to access the device. This can be done with either a custom driver information file (INF) installed on the system or by modifying the device firmware to provide the Microsoft OS Compatibility Descriptors during enumeration.*

Такой подход работает начиная с Win8 (на обновленной Win7 тоже должно работать).

Согласно этому, устройство поддерживает [Microsoft OS 2.0 Descriptors Specification](https://docs.microsoft.com/en-us/windows-hardware/drivers/usbcon/microsoft-os-2-0-descriptors-specification) и ему **НЕ нужен INF файл**. При подключении устройства Windows автоматический загрузит WinUsb драйвер.

Дев-утилиты для работы с устройством и загрузчиком уже используют такой подход.
Желательно чтобы в Регистраторе использовался такой же способ работы, без установки драйверов или INF файл со стандартным WinUsb (что излишне).  
Это позволит пользоваться на ПК с установленным Регистратором также и утилитами разработчика.
Устройство использует обновленные PID,VID, так что проблем совместимости со старыми устройствами не возникнет.

# Нерешенные проблемы/Вопросы

* Проблемы из-за перезапуска USB при изменении состояния устройства на мобильных ОС(Android)?
* Нужен ли отдельный файл описания устройства?

# Приложение

[Описание протокола команд](https://github.com/openbuttnakedgang/rfc/blob/master/spec_proto.md)

[Пример cхемы описания команд](https://github.com/openbuttnakedgang/rfc/blob/master/example_scheme.toml)

Примеры утилит для работы с новым интерфейсом:

* [Демо приложение для работы с новый интерфейсом](https://openbuttnakedgang.github.io/holter-wasm-app/)
* [Демо страница для работы с DFU загрузчиком](https://devanlai.github.io/webdfu/dfu-util/)